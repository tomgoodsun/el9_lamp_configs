## MySQL Serverのセットアップ

EL8以降はMySQL 8.0がデフォルトになっています。
今回はMySQLの公式リポジトリからインストールします。

以下にリポジトリ情報があります。
https://dev.mysql.com/downloads/repo/yum/

まずはリポジトリのインストール。

```bash
[root@alma9 ~]# dnf install https://dev.mysql.com/get/mysql84-community-release-el9-1.noarch.rpm
```

MySQL 8.0をインストール。デフォルトは最新のバージョンがインストールされてしまうので、`/etc/yum.repos.d/mysql-community.repo`を確認して、リポジトリを指定します。

```bash
[root@alma9 ~]# dnf install mysql-community-server --enablerepo=mysql80-community --disablerepo=mysql-8.4-lts-community
```

MySQL 8.0のパスワードポリシーは以下のパラメータで設定。特段指定しなくてもOKですが、今回はかなりゆるくします。

```
validate_password.changed_characters_percentage=0
validate_password.length=8
validate_password.mixed_case_count=0
validate_password.number_count=0
validate_password.policy=LOW
validate_password.special_char_count=0
```

設定ファイルのインストール。

```bash
[root@alma9 ~]# cp /etc/my.cnf /etc/my.cnf.orig
[root@alma9 ~]# wget https://raw.githubusercontent.com/tomgoodsun/el9_lamp_configs/master/config/etc/my.cnf -O /etc/my.cnf
```

MySQLの設定は以下を参考にします。前述の通り、パスワードに対する制限をかなりゆるくしています。

- [config/etc/my.cnf](config/etc/my.cnf)

MySQL 8.0ではインストール後、ログファイルに`root`の一時パスワードが記録されます。
それでログインして、まずパスワードを書き換えない限り何もできません。
起動してパスワードの確認をし、MySQLにログインして設定していきます。

```bash
[root@alma9 ~]# systemctl enable --now mysqld
[root@alma9 ~]# grep password /var/log/mysqld.log
2025-02-13T17:30:51.275627Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: AutoGeneratedP@ssw0rd
[root@alma9 ~]# mysql -u root -p
Enter password:

mysql> ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'P@ssw0rd';
Query OK, 0 rows affected (0.01 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

mysql> CREATE DATABASE mydb CHARACTER SET utf8;
Query OK, 1 row affected (0.00 sec)

mysql> CREATE USER mydb_user@'%' IDENTIFIED WITH mysql_native_password BY 'password';
Query OK, 0 rows affected (0.01 sec)

mysql> GRANT ALL PRIVILEGES ON mydb.* TO mydb_user@'%';
Query OK, 0 rows affected (0.00 sec)

mysql> FLUSH PRIVILEGES;
Query OK, 0 rows affected (0.00 sec)

mysql> SHOW WARNINGS;
Empty set (0.00 sec)

mysql> exit
```

その代わり`CREATE USER`文が使えるで、それを使って設定します。
あまりないかもしれませんが`CREATE USER`文を使用してパスワードのハッシュアルゴリズムを指定出来るようになっているみだいですが、変に設定してしまうとPHPとかから接続できなくなってしまうので注意が必要。

またエラーが発生しているかどうかは`SHOW WARNINGS;`で見ることが出来ます。

### デフォルトリポジトリのMySQL 8.0

デフォルトリポジトリからインストールすると、`/etc/my.cnf`以外に、`/etc/my.cnf.d`以下に設定ファイルを細分化しているようです。
主には以下3ファイルで、すべてバックアップして書き換えます。
`/etc/my.cnf`はこれらのファイルを最終的にインクルードするようになっているようです。
今回はここの対応はしません。

- `/etc/my.cnf.d/client.cnf`
    - クライアント設定ファイル
- `/etc/my.cnf.d/mysql-default-authentication-plugin.cnf`
    - 認証関連（パスワード等）の設定ファイル
- `/etc/my.cnf.d/mysql-server.cnf`
    - MySQLサーバーの設定。

ちなみにリポジトリ情報は以下にあります。

- Alma Linux 9
    -https://repo.almalinux.org/almalinux/9/AppStream/x86_64/os/Packages/#:~:text=mysql-server

